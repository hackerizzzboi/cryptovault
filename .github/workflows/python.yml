name: CryptoVault CI/CD

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # â­â­ ADD THIS STEP â­â­
    - name: Install dependencies
      run: |
        pip install cryptography
        echo "âœ… cryptography library installed"
    
    - name: Test imports
      run: |
        python -c "
        print('ğŸš€ Testing CryptoVault imports...')
        try:
            import tkinter
            from cryptography.hazmat.primitives import serialization, hashes
            from cryptography.hazmat.primitives.asymmetric import rsa, ec, padding
            from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
            from cryptography.hazmat.primitives import padding as sym_padding
            from cryptography.hazmat.backends import default_backend
            import json, os, base64, hashlib, secrets
            from datetime import datetime
            print('âœ… All imports successful!')
            
            # Test actual functionality
            print('ğŸ§ª Testing RSA key generation...')
            key = rsa.generate_private_key(
                public_exponent=65537,
                key_size=2048,
                backend=default_backend()
            )
            print(f'âœ… Generated {key.key_size}-bit RSA key')
            
            print('ğŸ‰ All cryptography tests passed!')
        except Exception as e:
            print(f'âŒ Import error: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
    
    - name: Check files
      run: |
        echo "ğŸ“ Project files:"
        ls -la
        echo ""
        echo "ğŸ“‹ Checking required files:"
        [ -f "cryptovault.py" ] && echo "âœ… cryptovault.py exists" || echo "âŒ cryptovault.py missing"
        [ -f "requirements.txt" ] && echo "âœ… requirements.txt exists" || echo "âš ï¸  requirements.txt missing"
        [ -f "README.md" ] && echo "âœ… README.md exists" || echo "âš ï¸  README.md missing"
    
    # â­â­ ADD THIS STEP TOO â­â­
    - name: Run application validation
      run: |
        echo "ğŸš€ Running CryptoVault Pro validation..."
        python -c "
        import sys
        sys.path.insert(0, '.')
        
        print('ğŸ” Loading cryptovault.py...')
        try:
            # Execute the file to load functions
            with open('cryptovault.py', 'r') as f:
                code = f.read()
            exec(code)
            
            print('âœ… File loaded successfully!')
            
            # Test the validation function
            print('ğŸ§ª Running CI/CD validation function...')
            if 'validate_cryptography_imports' in globals():
                success = validate_cryptography_imports()
                if success:
                    print('ğŸ‰ CI/CD validation PASSED!')
                else:
                    print('âŒ CI/CD validation FAILED!')
                    exit(1)
            else:
                print('âš ï¸  Validation function not found, but imports work!')
                
        except Exception as e:
            print(f'âŒ Error: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
    
    - name: Success message
      if: success()
      run: |
        echo "========================================="
        echo "ğŸ‰ CRYPTOVAULT CI/CD PIPELINE PASSED! ğŸ‰"
        echo "========================================="
        echo ""
        echo "âœ… All dependencies installed"
        echo "âœ… Cryptography imports working"
        echo "âœ… Application structure valid"
        echo "âœ… Ready for deployment"
        echo ""
        echo "ğŸš€ Push more features and watch it auto-test!"